---
title: "Geospatial Carpentry | Session 3: Working with raster data"
author: "Claudiu Forgaci"
date: "2022-11-21"
output: html_document
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{r lib}
library(tidyverse)
library(here)
library(raster)
library(rgdal)
```

# Intro to raster data (30 + 20 minutes)
## View Raster File Attirbutes
```{r}
# GDALinfo(here("data","NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif"))
GDALinfo(here("data","tud-dsm.tif"))
```

```{r}
TUD_dsm_info <- capture.output(
  GDALinfo(here("data","tud-dsm.tif"))
)
```

## Open a Raster in R

We are going to work with a Digital Surface Model (DSM) which is in the GeoTIFF format.
```{r}
# DSM_HARV <- raster(here("data","NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif"))
DSM_TUD <- raster(here("data","tud-dsm.tif"))
DSM_TUD
```

```{r}
summary(DSM_TUD)
```

```{r}
summary(DSM_TUD, maxsamp = ncell(DSM_TUD))
```

```{r}
# DSM_HARV_df <- as.data.frame(DSM_HARV, xy = TRUE)
DSM_TUD_df <- as.data.frame(DSM_TUD, xy = TRUE)
```

```{r}
str(DSM_TUD_df)
```

```{r}
# This might throw a memory error if the raster is too large
ggplot() +
    geom_raster(data = DSM_TUD_df , aes(x = x, y = y, fill = tud.dsm)) +
    scale_fill_viridis_c() +
    coord_quickmap()
```

```{r}
plot(DSM_TUD)
```

## View Raster Coordinate Reference System (CRS) in R

But what units are these?
```{r}
# CRS have been explained on Day 1
crs(DSM_TUD)
```

<!-- Skip the explanation of CRS -->

## Calculate the Min and Max value
```{r}
# minValue(DSM_HARV)
minValue(DSM_TUD)
```

```{r}
maxValue(DSM_TUD)
```

If Min and Max values haven't been calculated, you can set them with the `raster::setMinMax()` function.
```{r}
# Maybe skip this
DSM_TUD <- raster::setMinMax(DSM_TUD)
```

## Raster bands

To see how many bands a raster dataset has, use the `raster::nlayers()` function.
```{r}
nlayers(DSM_TUD)
```
This dataset has only 1 band. We will discuss multi-band raster data in a later episode.

## Dealing with missing data

In raster data, pixels with no value are represented with `NoDataValue`. That is usually the case with edge values where data is missing from the rectangular region of the raster. Use `rgdal::GDALinfo()` to check the metadata for missing data values.
```{r}
GDALinfo(here("data", "tud-dsm.tif"))
GDALinfo(here("data", "HARV_dsmCrop.tif"))
```


## Bad data values

Bad values are usually miscalculations that result in values out of a predefined range.
```{r}
# This code chunk is hidden in the lesson material
```

## Creating a histogram of raster values

A histogram can be used to inspect the distribution of raster values visually. It can show if there are values above the max or below the min of the expected range. We can create a histogram with the ggplot2 function `geom_histogram()`.
```{r}
# ggplot() +
#     geom_histogram(data = DSM_HARV_df, aes(HARV_dsmCrop))
ggplot() +
  geom_histogram(data = DSM_TUD_df, aes(tud.dsm))
```

Adjust the level of desired detail by setting the number of bins.
```{r}
# ggplot() +
#     geom_histogram(data = DSM_HARV_df, aes(HARV_dsmCrop), bins = 40)
ggplot() +
  geom_histogram(data = DSM_TUD_df, aes(tud.dsm), bins = 40)
```

### Challenge

```{r}
GDALinfo(here("data","HARV_DSMhill.tif"))
```


# Plotting raster data (40 + 30 minutes - 10 minutes about plot formatting - 15 minutes details = 45 minutes)

```{r}
# DSM_HARV_df <- DSM_HARV_df %>%
#   mutate(fct_elevation = cut(HARV_dsmCrop, breaks = 3))
# 
# ggplot() +
#     geom_bar(data = DSM_HARV_df, aes(fct_elevation))

DSM_TUD_df <- DSM_TUD_df %>%
  mutate(fct_elevation = cut(tud.dsm, breaks = 3))

ggplot() +
    geom_bar(data = DSM_TUD_df, aes(fct_elevation))
```
To see the cutoff values:
```{r}
unique(DSM_TUD_df$fct_elevation)
```

To show count number of pixels in each group:
```{r}
DSM_TUD_df %>%
        group_by(fct_elevation) %>%
        count()
```

To customize cutoff values:
```{r}
# custom_bins <- c(300, 350, 400, 450)
# 
# DSM_HARV_df <- DSM_HARV_df %>%
#   mutate(fct_elevation_cb = cut(HARV_dsmCrop, breaks = custom_bins))
# 
# unique(DSM_HARV_df$fct_elevation_cb)

custom_bins <- c(-10, 0, 5, 100)

DSM_TUD_df <- DSM_TUD_df %>%
  mutate(fct_elevation_cb = cut(tud.dsm, breaks = custom_bins))

unique(DSM_TUD_df$fct_elevation_cb)
```

```{r}
ggplot() +
  geom_bar(data = DSM_TUD_df, aes(fct_elevation_cb))
```

```{r}
DSM_TUD_df %>%
  group_by(fct_elevation_cb) %>%
  count()
```

```{r}
ggplot() +
  geom_raster(data = DSM_TUD_df , aes(x = x, y = y, fill = fct_elevation_cb)) + 
  coord_quickmap()
```

<!-- Remove the plot formatting part -->

Customising colors:
```{r}
terrain.colors(3)
```

```{r}
ggplot() +
 geom_raster(data = DSM_TUD_df , aes(x = x, y = y,
                                      fill = fct_elevation_cb)) + 
    scale_fill_manual(values = terrain.colors(3)) + 
    coord_quickmap()
```

```{r}
my_col <- terrain.colors(3)

ggplot() +
 geom_raster(data = DSM_TUD_df , aes(x = x, y = y,
                                      fill = fct_elevation_cb)) + 
    scale_fill_manual(values = my_col, name = "Elevation") + 
    coord_quickmap()
```

### Challenge

```{r}
# DSM_HARV_df <- DSM_HARV_df %>%
#   mutate(fct_elevation_6 = cut(HARV_dsmCrop, breaks = 6))
# 
# unique(DSM_HARV_df$fct_elevation_6)

DSM_TUD_df <- DSM_TUD_df %>%
  mutate(fct_elevation_6 = cut(tud.dsm, breaks = 6))

unique(DSM_TUD_df$fct_elevation_6)
```

```{r}
my_col <- terrain.colors(6)

ggplot() +
  geom_raster(data = DSM_TUD_df, aes(x = x, y = y,
                                       fill = fct_elevation_6)) +
  scale_fill_manual(values = my_col, name = "Elevation") +
  coord_quickmap() +
  xlab("X") +
  ylab("Y") +
  labs(title = "Elevation Classes of the Harvard Forest Digital Surface Model (DSM)")
```

<!-- Remove the plot formatting part -->
## Layering rasters
```{r}
# DSM_hill_HARV <- raster(here("data","NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_DSMhill.tif"))
# DSM_hill_HARV

DSM_hill_TUD <- raster(here("data","tud-dsm-hill.tif"))
DSM_hill_TUD
```

```{r}
# DSM_hill_HARV_df <- as.data.frame(DSM_hill_HARV, xy = TRUE)
# str(DSM_hill_HARV_df)
DSM_hill_TUD_df <- as.data.frame(DSM_hill_TUD, xy = TRUE)
str(DSM_hill_TUD_df)
```

```{r}
ggplot() +
  geom_raster(data = DSM_hill_TUD_df,
              aes(x = x, y = y, alpha = tud.dsm.hill)) + 
  scale_alpha(range =  c(0.15, 0.65), guide = "none") + 
  coord_quickmap()
```

```{r}
ggplot() +
  geom_raster(data = DSM_TUD_df , 
              aes(x = x, y = y, 
                  fill = tud.dsm)) + 
  geom_raster(data = DSM_hill_TUD_df, 
              aes(x = x, y = y, 
                  alpha = tud.dsm.hill)) +  
  scale_fill_viridis_c() +  
  scale_alpha(range = c(0.15, 0.65), guide = "none") +  
  ggtitle("Elevation with hillshade") +
  coord_quickmap()
```

### Challenge

Repeat with DTM

```{r}
# # CREATE DSM MAPS
# 
# # import DSM data
# DSM_SJER <- raster(here("data","NEON-DS-Airborne-Remote-Sensing/SJER/DSM/SJER_dsmCrop.tif"))
# # convert to a df for plotting
# DSM_SJER_df <- as.data.frame(DSM_SJER, xy = TRUE)
# 
# # import DSM hillshade
# DSM_hill_SJER <- raster(here("data", "NEON-DS-Airborne-Remote-Sensing/SJER/DSM/SJER_dsmHill.tif"))
# # convert to a df for plotting
# DSM_hill_SJER_df <- as.data.frame(DSM_hill_SJER, xy = TRUE)
# 
# # Build Plot
# ggplot() +
#     geom_raster(data = DSM_SJER_df ,
#                 aes(x = x, y = y,
#                      fill = SJER_dsmCrop,
#                      alpha = 0.8)
#                 ) +
#     geom_raster(data = DSM_hill_SJER_df,
#                 aes(x = x, y = y,
#                   alpha = SJER_dsmHill)
#                 ) +
#     scale_fill_viridis_c() +
#     guides(fill = guide_colorbar()) +
#     scale_alpha(range = c(0.4, 0.7), guide = "none") +
#     # remove grey background and grid lines
#     theme_bw() +
#     theme(panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank()) +
#     xlab("UTM Easting Coordinate (m)") +
#     ylab("UTM Northing Coordinate (m)") +
#     ggtitle("DSM with Hillshade") +
#     coord_quickmap()
```

```{r}
# CREATE DTM MAP
# # import DTM
# DTM_SJER <- raster(here("data","NEON-DS-Airborne-Remote-Sensing/SJER/DTM/SJER_dtmCrop.tif"))
# DTM_SJER_df <- as.data.frame(DTM_SJER, xy = TRUE)
# 
# # DTM Hillshade
# DTM_hill_SJER <- raster(here("data","NEON-DS-Airborne-Remote-Sensing/SJER/DTM/SJER_dtmHill.tif"))
# DTM_hill_SJER_df <- as.data.frame(DTM_hill_SJER, xy = TRUE)
# 
# ggplot() +
#     geom_raster(data = DTM_SJER_df ,
#                 aes(x = x, y = y,
#                      fill = SJER_dtmCrop,
#                      alpha = 2.0)
#                 ) +
#     geom_raster(data = DTM_hill_SJER_df,
#                 aes(x = x, y = y,
#                   alpha = SJER_dtmHill)
#                 ) +
#     scale_fill_viridis_c() +
#     guides(fill = guide_colorbar()) +
#     scale_alpha(range = c(0.4, 0.7), guide = "none") +
#     theme_bw() +
#     theme(panel.grid.major = element_blank(), 
#           panel.grid.minor = element_blank()) +
#     theme(axis.title.x = element_blank(),
#           axis.title.y = element_blank()) +
#     ggtitle("DTM with Hillshade") +
#     coord_quickmap()

# import DTM
DTM_TUD <- raster(here("data","tud-dtm.tif"))
DTM_TUD_df <- as.data.frame(DTM_TUD, xy = TRUE)

# DTM Hillshade
DTM_hill_TUD <- raster(here("data","tud-dtm-hill.tif"))
DTM_hill_TUD_df <- as.data.frame(DTM_hill_TUD, xy = TRUE)

ggplot() +
    geom_raster(data = DTM_TUD_df ,
                aes(x = x, y = y,
                     fill = tud.dtm,
                     alpha = 2.0)
                ) +
    geom_raster(data = DTM_hill_TUD_df,
                aes(x = x, y = y,
                  alpha = tud.dtm.hill)
                ) +
    scale_fill_viridis_c() +
    guides(fill = guide_colorbar()) +
    scale_alpha(range = c(0.4, 0.7), guide = "none") +
    theme_bw() +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank()) +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank()) +
    ggtitle("DTM with Hillshade") +
    coord_quickmap()
```

# Reproject raster data (40 + 20 minutes - 10 minutes instruction details - 20 minutes challenges = 30 minutes)

What happens when maps don't line up? That is usually a sign that layers are in different coordinate reference systems (CRS).

```{r}
DTM_TUD <- raster(here("data","tud-dtm.tif"))

DTM_hill_TUD <- raster(here("data","tud-dtm-hill-ETRS89.tif"))
```

```{r}
DTM_TUD_df <- as.data.frame(DTM_TUD, xy = TRUE)

DTM_hill_TUD_df <- as.data.frame(DTM_hill_TUD, xy = TRUE)
```

```{r}
ggplot() +
     geom_raster(data = DTM_TUD_df , 
                 aes(x = x, y = y, 
                  fill = tud.dtm)) + 
     geom_raster(data = DTM_hill_TUD_df, 
                 aes(x = x, y = y, 
                   alpha = tud.dtm.hill.ETRS89)) +
     scale_fill_gradientn(name = "Elevation", colors = terrain.colors(10)) + 
     coord_quickmap()
```

```{r}
ggplot() +
geom_raster(data = DTM_TUD_df,
    aes(x = x, y = y,
    fill = tud.dtm)) +
scale_fill_gradientn(name = "Elevation", colors = terrain.colors(10)) + 
coord_quickmap()
```

```{r}
ggplot() +
geom_raster(data = DTM_hill_TUD_df,
    aes(x = x, y = y,
    alpha = tud.dtm.hill.ETRS89)) + 
    coord_quickmap()
```
### Challenge

```{r}
crs(DTM_TUD)
```

```{r}
crs(DTM_hill_TUD)
```

## Reproject rasters

```{r}
DTM_hill_EPSG28992_TUD <- projectRaster(DTM_hill_TUD,
                                       crs = crs(DTM_TUD))
```

```{r}
crs(DTM_hill_EPSG28992_TUD)
```

```{r}
crs(DTM_hill_TUD)
```

```{r}
extent(DTM_hill_EPSG28992_TUD)
```

```{r}
extent(DTM_hill_TUD)
```


### Challenge

## Dealing with raster resolution

```{r}
res(DTM_hill_EPSG28992_TUD)
```

```{r}
res(DTM_TUD)
```

```{r}
DTM_hill_EPSG28992_TUD <- projectRaster(DTM_hill_TUD,
                                         crs = crs(DTM_TUD),
                                         res = res(DTM_TUD))
```

```{r}
res(DTM_hill_EPSG28992_TUD)
```

```{r}
res(DTM_TUD)
```

```{r}
DTM_hill_TUD_2_df <- as.data.frame(DTM_hill_EPSG28992_TUD, xy = TRUE)
```

```{r}
ggplot() +
     geom_raster(data = DTM_TUD_df , 
                 aes(x = x, y = y, 
                  fill = tud.dtm)) + 
     geom_raster(data = DTM_hill_TUD_2_df, 
                 aes(x = x, y = y, 
                   alpha = tud.dtm.hill.ETRS89)) +
     scale_fill_gradientn(name = "Elevation", colors = terrain.colors(10)) + 
     coord_quickmap()
```

### Challenge

<!-- Skip this challenge -->

```{r}
# # import DSM
# DSM_SJER <- raster(here("data","NEON-DS-Airborne-Remote-Sensing/SJER/DSM/SJER_dsmCrop.tif"))
# # import DSM hillshade
# DSM_hill_SJER_WGS <-
# raster(here("data","NEON-DS-Airborne-Remote-Sensing/SJER/DSM/SJER_DSMhill_WGS84.tif"))
# 
# # reproject raster
# DTM_hill_UTMZ18N_SJER <- projectRaster(DSM_hill_SJER_WGS,
#                                   crs = crs(DSM_SJER),
#                                   res = 1)
# 
# # convert to data.frames
# DSM_SJER_df <- as.data.frame(DSM_SJER, xy = TRUE)
# 
# DSM_hill_SJER_df <- as.data.frame(DTM_hill_UTMZ18N_SJER, xy = TRUE)
# 
# ggplot() +
#      geom_raster(data = DSM_hill_SJER_df, 
#                  aes(x = x, y = y, 
#                    alpha = SJER_DSMhill_WGS84)
#                  ) +
#      geom_raster(data = DSM_SJER_df, 
#              aes(x = x, y = y, 
#                   fill = SJER_dsmCrop,
#                   alpha=0.8)
#              ) + 
#      scale_fill_gradientn(name = "Elevation", colors = terrain.colors(10)) + 
#      coord_quickmap()
```

# Raster calculations (40 + 20 minutes - 15 minutes raster math - 15 minutes challenges = 30 minutes)
## Raster calculations in R
```{r}
GDALinfo(here("data","tud-dtm.tif"))
```

```{r}
GDALinfo(here("data","tud-dsm.tif"))
```

```{r}
 ggplot() +
      geom_raster(data = DTM_TUD_df , 
              aes(x = x, y = y, fill = tud.dtm)) +
     scale_fill_gradientn(name = "Elevation", colors = terrain.colors(10)) + 
     coord_quickmap()
```

```{r}
 ggplot() +
      geom_raster(data = DSM_TUD_df , 
              aes(x = x, y = y, fill = tud.dsm)) +
     scale_fill_gradientn(name = "Elevation", colors = terrain.colors(10)) + 
     coord_quickmap()
```

## Raster math and Canopy Height Models (DROP THIS PART)

```{r}
CHM_TUD <- DSM_TUD - DTM_TUD

CHM_TUD_df <- as.data.frame(CHM_TUD, xy = TRUE)
```

```{r}
 ggplot() +
   geom_raster(data = CHM_TUD_df , 
               aes(x = x, y = y, fill = layer)) + 
   scale_fill_gradientn(name = "Canopy Height", colors = terrain.colors(10)) + 
   coord_quickmap()
```

```{r}
ggplot(CHM_TUD_df) +
    geom_histogram(aes(layer))
```

### Challenge

```{r}
custom_bins <- c(0, 10, 20, 30, 100)
CHM_TUD_df <- CHM_TUD_df %>%
                  mutate(canopy_discrete = cut(layer, breaks = custom_bins))

ggplot() +
  geom_raster(data = CHM_TUD_df , aes(x = x, y = y,
                                       fill = canopy_discrete)) + 
     scale_fill_manual(values = terrain.colors(4)) + 
     coord_quickmap()
```

## Efficient raster calculations: overlay function

```{r}
CHM_ov_TUD <- overlay(DSM_TUD,
                       DTM_TUD,
                       fun = function(r1, r2) { return( r1 - r2) })
```

```{r}
CHM_ov_TUD_df <- as.data.frame(CHM_ov_TUD, xy = TRUE)
```

```{r}
 ggplot() +
   geom_raster(data = CHM_ov_TUD_df, 
               aes(x = x, y = y, fill = layer)) + 
   scale_fill_gradientn(name = "Canopy Height", colors = terrain.colors(10)) + 
   coord_quickmap()
```

## Export a GeoTIFF

```{r}
writeRaster(CHM_ov_TUD, here("fig_output","CHM_TUD.tiff"),
            format="GTiff",
            overwrite=TRUE,
            NAflag=-9999)
```

### Challenge

```{r}
# CHM_ov_SJER <- overlay(DSM_SJER,
#                        DTM_SJER,
#                        fun = function(r1, r2){ return(r1 - r2) })
```

```{r}
# CHM_ov_SJER_df <- as.data.frame(CHM_ov_SJER, xy = TRUE)
```

```{r}
# ggplot(CHM_ov_SJER_df) +
#     geom_histogram(aes(layer))
```

```{r}
# ggplot() +
#   geom_raster(data = CHM_ov_SJER_df,
#               aes(x = x, y = y,
#                   fill = layer)) +
#   scale_fill_gradientn(name = "Canopy Height",
#                        colors = terrain.colors(10)) +
#   coord_quickmap()
```

```{r}
# writeRaster(CHM_ov_SJER, here("fig_output", "chm_ov_SJER.tiff"),
#             format = "GTiff",
#             overwrite = TRUE,
#             NAflag = -9999)
```

```{r}
ggplot(CHM_TUD_df) +
    geom_histogram(aes(layer))
```

```{r}
ggplot(CHM_ov_TUD_df) +
    geom_histogram(aes(layer))
```

# Work with multi-band rasters (40 + 20 minutes - 15 minutes details - 15 minutes challenges = 30 minutes)
##Getting Started with Multi-Band Data in R

The `raster()` function only reads in the first band, in this case the red band of an RGB raster
```{r}
# RGB_band1_HARV <- raster(here("data","NEON-DS-Airborne-Remote-Sensing/HARV/RGB_Imagery/HARV_RGB_Ortho.tif"))
RGB_band1_TUD <- raster(here("data","tudlib-rgb.tif"))
```

```{r}
RGB_band1_TUD_df  <- as.data.frame(RGB_band1_TUD, xy = TRUE)
```

```{r}
ggplot() +
  geom_raster(data = RGB_band1_TUD_df,
              aes(x = x, y = y, alpha = tudlib.rgb)) + 
  coord_quickmap()
```

```{r}
RGB_band1_TUD
```

```{r}
nbands(RGB_band1_TUD)
```

To import the green band:
```{r}
RGB_band2_TUD <-  raster(here("data","tudlib-rgb.tif"), band = 2)
```

```{r}
RGB_band2_TUD_df <- as.data.frame(RGB_band2_TUD, xy = TRUE)
```

```{r}
ggplot() +
  geom_raster(data = RGB_band2_TUD_df,
              aes(x = x, y = y, alpha = tudlib.rgb)) + 
  coord_equal()
```

## Raster stacks

The `stack()` function brings in all bands
```{r}
RGB_stack_TUD <- stack(here("data","tudlib-rgb.tif"))
```

```{r}
RGB_stack_TUD
```

```{r}
RGB_stack_TUD@layers
```

```{r}
RGB_stack_TUD[[2]]
```

```{r}
RGB_stack_TUD_df  <- as.data.frame(RGB_stack_TUD, xy = TRUE)
```

```{r}
str(RGB_stack_TUD_df)
```

```{r}
ggplot() +
  geom_histogram(data = RGB_stack_TUD_df, aes(tudlib.rgb.1))
```

```{r}
ggplot() +
  geom_raster(data = RGB_stack_TUD_df,
              aes(x = x, y = y, alpha = tudlib.rgb.2)) + 
  coord_quickmap()
```

## Create a three-band image

```{r}
plotRGB(RGB_stack_TUD,
        r = 1, g = 2, b = 3)
```

Which is the same with `terra`
```{r}
terra::plotRGB(RGB_stack_TUD,
        r = 1, g = 2, b = 3)
```

```{r}
plotRGB(RGB_stack_TUD,
        r = 1, g = 2, b = 3,
        scale = 800,
        stretch = "lin")
```

```{r}
plotRGB(RGB_stack_TUD,
        r = 1, g = 2, b = 3,
        scale = 800,
        stretch = "hist")
```

### Challenge

<!-- Skip or change challenge -->

```{r}
GDALinfo(here("data","HARV_Ortho_wNA.tif"))
```

```{r}
HARV_NA <- stack(here("data","HARV_Ortho_wNA.tif"))
```

```{r}
plotRGB(HARV_NA,
        r = 1, g = 2, b = 3)
```

```{r}
GDALinfo(here("data","HARV_RGB_Ortho.tif"))
```

## RasterStack vs. RasterBrick

```{r}
object.size(RGB_stack_TUD)
```

```{r}
RGB_brick_TUD <- brick(RGB_stack_TUD)

object.size(RGB_brick_TUD)
```

```{r}
plotRGB(RGB_brick_TUD)
```

```{r}
methods(class=class(RGB_stack_TUD))
```

```{r}
methods(class=class(RGB_stack_TUD[1]))
```
<<<<<<< HEAD
=======

# ---

# Manipulate raster data (40 + 20 minutes) INTEGRATE INTO THE LAST PART

## Crop a raster to a vector extent

```{r}
ggplot() +
  geom_raster(data = CHM_TUD_df, aes(x = x, y = y, fill = layer)) + 
  scale_fill_gradientn(name = "Canopy Height", colors = terrain.colors(10)) +
  geom_sf(data = boundary_Delft, color = "blue", fill = NA) +  # notice that boundary_Delft is in WGS84
  coord_sf()

boundary_Delft <- st_transform(boundary_Delft, 28992)

ggplot() +
  geom_raster(data = CHM_TUD_df, aes(x = x, y = y, fill = layer)) + 
  scale_fill_gradientn(name = "Canopy Height", colors = terrain.colors(10)) +
  geom_sf(data = boundary_Delft, color = "blue", fill = NA) +
  coord_sf()
```

```{r}
boundary_Delft_28992 <- st_transform(boundary_Delft, 28992)

CHM_TUD_Cropped <- crop(x = CHM_TUD, y = boundary_Delft_28992)
CHM_TUD_Masked <- mask(CHM_TUD_Cropped, boundary_Delft_28992)
```

```{r}
CHM_TUD_Masked_df <- as.data.frame(CHM_TUD_Masked, xy = TRUE)

ggplot() +
  # geom_sf(data = st_as_sfc(st_bbox(CHM_TUD)), fill = "green",
  #         color = "green", alpha = .2) +
  geom_raster(data = CHM_TUD_Masked_df,
              aes(x = x, y = y, fill = layer)) + 
  scale_fill_gradientn(name = "Canopy Height", colors = terrain.colors(10)) + 
  coord_sf()
```

```{r}
ggplot() +
  geom_raster(data = CHM_TUD_Cropped_df,
              aes(x = x, y = y, fill = layer)) + 
  geom_sf(data = boundary_Delft_28992, color = "blue", fill = NA) + 
  scale_fill_gradientn(name = "Canopy Height", colors = terrain.colors(10)) + 
  coord_sf()
```

```{r}
st_bbox(CHM_TUD)
```

```{r}
st_bbox(CHM_TUD_Cropped)
```

```{r}
st_bbox(boundary_Delft_28992)
```

```{r}
# st_bbox(plot_locations_sp_HARV)

leisure_locations_selection <- st_read(here("data", "delft-leisure.shp")) %>% 
  filter(leisure %in% c("playground", "picnic_table"))

st_bbox(leisure_locations_selection)
```

### Challenge

```{r}
CHM_plots_TUDcrop <- crop(x = CHM_TUD, y = leisure_locations_selection)

CHM_plots_TUDcrop_df <- as.data.frame(CHM_plots_TUDcrop, xy = TRUE)

ggplot() + 
  geom_raster(data = CHM_plots_TUDcrop_df, aes(x = x, y = y, fill = layer)) + 
  scale_fill_gradientn(name = "Canopy Height", colors = terrain.colors(10)) + 
  geom_sf(data = leisure_locations_selection) + 
  coord_sf()
```

```{r}
tree_building_height <- raster::extract(x = CHM_TUD, y = boundary_Delft_28992, df = TRUE)

str(tree_building_height)
```

```{r}
ggplot() + 
  geom_histogram(data = tree_building_height, aes(x = layer)) +
  ggtitle("Histogram of CHM Height Values (m)") +
  xlab("Tree or Building Height") + 
  ylab("Frequency of Pixels")
```

```{r}
summary(tree_building_height$layer)
```

```{r}
mean_tree_building_height_AOI <- raster::extract(x = CHM_TUD, y = boundary_Delft_28992, fun = mean)

mean_tree_building_height_AOI
```

```{r}
point_Delft <- st_read(here("data", "delft-leisure.shp"))

mean_tree_height_leisure <- raster::extract(x = CHM_TUD,
                                  y = point_Delft,
                                  buffer = 20,
                                  fun = mean)

mean_tree_height_leisure
```

### Challenge

```{r}
# extract data at each plot location
mean_tree_building_height_leisure_TUD <- raster::extract(x = CHM_TUD,
                                       y = leisure_locations_selection,
                                       buffer = 20,
                                       fun = mean,
                                       df = TRUE)

# view data
mean_tree_building_height_leisure_TUD
```

```{r}
# plot data
ggplot(data = mean_tree_building_height_leisure_TUD, aes(ID, layer)) + 
  geom_col() + 
  ggtitle("Mean Tree and Building Height at each location") + 
  xlab("Location ID") + 
  ylab("Tree and Building Height (m)")
```
>>>>>>> cb2bc1b2b4038ec5800d60e3d3fa2f0335f45589
