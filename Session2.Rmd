---
title: "Geospatial Carpentry | Session 2: Working with vector data"
author: "Claudiu Forgaci"
date: "2022-11-18"
output: html_document
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{r lib}
# These packages were installed in preparation to the workshop
library(tidyverse)  # tools for wrangling, reshaping and visualizing data
library(here)       # managing paths
library(sf)         # working with spatial vector data
```

# Open and plot shapefiles (20 + 10 minutes)

## Import shapefiles

```{r}
# aoi_boundary_HARV <- st_read(here("data", "NEON-DS-Site-Layout-Files/HARV/HarClip_UTMZ18.shp"))
boundary_Delft <- st_read(here("data", "delft-boundary.shp"))
```

## Shapefile Metadata & Attributes

```{r}
# st_geometry_type(aoi_boundary_HARV)
st_geometry_type(boundary_Delft)
```

```{r}
# st_crs(aoi_boundary_HARV)
st_crs(boundary_Delft)
```

```{r}
# st_bbox(aoi_boundary_HARV)
st_bbox(boundary_Delft)
```

```{r}
# aoi_boundary_HARV
boundary_Delft
```

## Plot a shapefile

```{r}
# ggplot already introduced in the morning
ggplot(data = boundary_Delft) +
  geom_sf(size = 3, color = "black", fill = "cyan1") +
  ggtitle("AOI Boundary Plot") +
  coord_sf()
```

```{r}
# lines_HARV <- st_read(here("data", "NEON-DS-Site-Layout-Files/HARV/HARV_roads.shp"))
lines_Delft <- st_read(here("data", "delft-streets.shp"))
```

```{r}
# point_HARV <- st_read(here("data", "NEON-DS-Site-Layout-Files/HARV/HARVtower_UTM18N.shp" ))
point_Delft <- st_read(here("data", "delft-leisure.shp"))
```

```{r}
# class(lines_HARV)
class(lines_Delft)
```

```{r}
# class(point_HARV)
class(point_Delft)
```

```{r}
# st_crs(lines_HARV)
st_crs(lines_Delft)
```

```{r}
# st_bbox(lines_HARV)
st_bbox(lines_Delft)
```

```{r}
# st_crs(point_HARV)
st_crs(point_Delft)
```

```{r}
st_bbox(point_Delft)
```

# Explore and plot by vector layer attributes (40 + 20 minutes)

```{r}
# data frames introduced in the morning; sf objects have additional metadata and a 'sticky' geometry column
# point_HARV
point_Delft
```

```{r}
# ncol(lines_HARV)
ncol(lines_Delft)
```

```{r}
# names(lines_HARV)
names(lines_Delft)
```

```{r}
# head(lines_HARV)
head(lines_Delft)
```

### Challenge

```{r}
ncol(point_Delft)
```

```{r}
# ncol(aoi_boundary_HARV)
ncol(boundary_Delft)
```

```{r}
# $ operator already introduced in the morning
# point_HARV$Ownership
head(point_Delft$leisure)
```

```{r}
# names(point_HARV)
names(point_Delft)
```

## Explore values within one attribute

```{r}
# lines_HARV$TYPE
lines_Delft$highway
```

```{r}
# levels(factor(lines_HARV$TYPE))
levels(factor(lines_Delft$highway))
```

## Subset features

```{r}
# data wrangling with dplyr introduced in the morning

# footpath_HARV <- lines_HARV %>% 
#   filter(TYPE == "footpath")
# 
# nrow(footpath_HARV)

cycleway_Delft <- lines_Delft %>% 
  filter(highway == "cycleway")

nrow(cycleway_Delft)
```

```{r}
ggplot(data = cycleway_Delft) +
  geom_sf() +
  ggtitle("Slow mobility network in Delft", subtitle = "Cycleways") +
  coord_sf()
```

### Challenge

1. Create a new object that only contains the motorways in Delft. 
2. How many features does the new object have? 
3. Plot the motorways.

```{r}
# boardwalk_HARV <- lines_HARV %>%
#   filter(TYPE == "boardwalk")
motorway_Delft <- lines_Delft %>% 
  filter(highway == "motorway")
```

```{r}
# nrow(boardwalk_HARV)
nrow(motorway_Delft)
```

```{r}
# ggplot(data = boardwalk_HARV) + 
#   geom_sf(size = 1.5) +
#   ggtitle("Fast mobility network", subtitle = "Motorways") + 
#   coord_sf()
ggplot(data = motorway_Delft) + 
  geom_sf(size = 1.5) +
  ggtitle("Fast mobility network", subtitle = "Motorways") + 
  coord_sf()
```

```{r}
# stoneWall_HARV <- lines_HARV %>% 
#   filter(TYPE == "stone wall")
# 
# nrow(stoneWall_HARV)
pedestrian_Delft <- lines_Delft %>% 
  filter(highway == "pedestrian")
nrow(pedestrian_Delft)
```

```{r}
# ggplot(data = stoneWall_HARV) +
#   geom_sf( aes(color = factor(OBJECTID)), size = 1.5) +
#   labs(color = 'Wall ID') +
#   ggtitle("NEON Harvard Forest Field Site", subtitle = "Stonewalls") + 
#   coord_sf()
ggplot() +
  # geom_sf(data = boundary_Delft, fill = "white", alpha = 0.5) +
  geom_sf(data = pedestrian_Delft) +
  ggtitle("Slow mobility network", subtitle = "Pedestrian") + 
  coord_sf()
```

## Customize plots

```{r}
# levels(factor(lines_HARV$TYPE))
levels(factor(lines_Delft$highway))
```

```{r}
road_types <- c("motorway", "primary", "secondary", "cycleway")

lines_Delft_selection <- lines_Delft %>% 
  filter(highway %in% road_types) %>% 
  mutate(highway = factor(highway, levels = road_types))
```

```{r}
road_colors <- c("blue", "green", "navy", "purple")
```

```{r}
# ggplot(data = lines_HARV) +
#   geom_sf(aes(color = TYPE)) + 
#   scale_color_manual(values = road_colors) +
#   labs(color = 'Road Type') +
#   ggtitle("NEON Harvard Forest Field Site", subtitle = "Roads & Trails") + 
#   coord_sf()
ggplot(data = lines_Delft_selection) +
  geom_sf(aes(color = highway)) + 
  scale_color_manual(values = road_colors) +
  labs(color = 'Road Type') +
  ggtitle("Road network of Delft", subtitle = "Roads & Cycleways") + 
  coord_sf()
```

## Adjust line width

```{r}
line_widths <- c(1, 0.75, 0.5, 0.25)
```

```{r}
ggplot(data = lines_Delft_selection) +
  geom_sf(aes(color = highway, size = highway)) +
  scale_color_manual(values = road_colors) +
  labs(color = 'Road Type') +
  scale_size_manual(values = line_widths) +
  ggtitle("Mobility network of Delft", subtitle = "Roads & Cycleways") + 
  coord_sf()
```

### Challenge

```{r}
# levels(factor(lines_HARV$TYPE))
levels(factor(lines_Delft_selection$highway))
```


```{r}
line_width <- c(0.25, 0.75, 0.5, 1)
```

```{r}
ggplot(data = lines_Delft_selection) +
  geom_sf(aes(size = highway)) +
  scale_size_manual(values = line_width) +
  ggtitle("Mobility network of Delft", subtitle = "Roads & Cycleways - Line width varies") + 
  coord_sf()
```

## Add plot legend

```{r}
ggplot(data = lines_Delft_selection) + 
  geom_sf(aes(color = highway), size = 1.5) +
  scale_color_manual(values = road_colors) +
  labs(color = 'Road Type') + 
  ggtitle("Mobility network of Delft", 
          subtitle = "Roads & Cycleways - Default Legend") + 
  coord_sf()
```

```{r}
ggplot(data = lines_Delft_selection) + 
  geom_sf(aes(color = highway), size = 1.5) +
  scale_color_manual(values = road_colors) + 
  labs(color = 'Road Type') +
  theme(legend.text = element_text(size = 20), 
        legend.box.background = element_rect(size = 1)) + 
  ggtitle("Mobility network of Delft", 
          subtitle = "Roads & Cycleways - Modified Legend") +
  coord_sf()
```

```{r}
new_colors <- c("springgreen", "blue", "magenta", "orange")

ggplot(data = lines_Delft_selection) + 
  geom_sf(aes(color = highway), size = 1.5) + 
  scale_color_manual(values = new_colors) +
  labs(color = 'Road Type') +
  theme(legend.text = element_text(size = 20), 
        legend.box.background = element_rect(size = 1)) + 
  ggtitle("Mobility network of Delft", 
          subtitle = "Roads & Cycleways - Modified Legend") +
  coord_sf()
```

### Challenge 

```{r}
# class(lines_HARV$BicyclesHo)
class(lines_Delft_selection$highway)
```

```{r}
# levels(factor(lines_HARV$BicyclesHo))
levels(factor(lines_Delft$highway))
```

```{r}
# lines_removeNA <- lines_HARV[!is.na(lines_HARV$BicyclesHo),] 
```

```{r}
# First, create a data frame with only those roads where bicycles and horses are allowed
lines_Delft_bicycle <- lines_Delft %>% 
  filter(highway == "cycleway")

# Next, visualise using ggplot
ggplot(data = lines_Delft) +
  geom_sf() +
  geom_sf(data = lines_Delft_bicycle, aes(color = highway), size = 2) +
  scale_color_manual(values = "magenta") +
  ggtitle("Mobility network in Delft", subtitle = "Roads dedicated to Bikes") +
  coord_sf()
```

```{r}
# state_boundary_US <- st_read(here("data", "NEON-DS-Site-Layout-Files/US-Boundary-Layers/US-State-Boundaries-Census-2014.shp"))
municipal_boundaries_NL <- st_read(here("data", "nl-gemeenten.shp"))
```

```{r}
# levels(factor(state_boundary_US$region))
levels(factor(municipal_boundaries_NL$ligtInPr_1))
```

```{r}
# Optionally, colors can be predefined
# colors <- c("purple", "springgreen", "yellow", "brown", "navy", "lightblue", "red", "orange", "blue", "green3", "grey", "magenta")
```

```{r}
ggplot(data = municipal_boundaries_NL) +
  geom_sf(aes(color = ligtInPr_1), size = 1) +
  # scale_color_manual(values = colors) +
  ggtitle("Contiguous NL Municipal Boundaries") + 
  coord_sf()
```

# Plot multiple shapefiles (40 + 20 minutes - 15 minutes from plot costomisation)

```{r}
# ggplot() + 
#   geom_sf(data = aoi_boundary_HARV, fill = "grey", color = "grey") +
#   geom_sf(data = lines_HARV, aes(color = TYPE), size = 1) +
#   geom_sf(data = point_HARV) +
#   ggtitle("NEON Harvard Forest Field Site") + 
#   coord_sf()
ggplot() + 
  geom_sf(data = boundary_Delft, fill = "grey", color = "grey") +
  geom_sf(data = lines_Delft_selection, aes(color = highway), size = 1) +
  geom_sf(data = point_Delft) +
  ggtitle("Mobility network of Delft") + 
  coord_sf()
```

```{r}
# ggplot() +
#   geom_sf(data = aoi_boundary_HARV, fill = "grey", color = "grey") +
#   geom_sf(data = lines_HARV, aes(color = TYPE),
#           show.legend = "line", size = 1) +
#   geom_sf(data = point_HARV, aes(fill = Sub_Type), color = "black") +
#   scale_color_manual(values = road_colors) +
#   scale_fill_manual(values = "black") +
#   ggtitle("NEON Harvard Forest Field Site") +
#   coord_sf()
leisure_colors <- rainbow(15)
ggplot() + 
  geom_sf(data = boundary_Delft, fill = "grey", color = "grey") +
  geom_sf(data = lines_Delft_selection, aes(color = highway),
          show.legend = "line", size = 1) +
  geom_sf(data = point_Delft, aes(fill = leisure), color = "black") +
  scale_color_manual(values = road_colors) +
  scale_fill_manual(values = leisure_colors) +
  ggtitle("Mobility network of Delft") + 
  coord_sf()
```

```{r}
# ggplot() + 
#   geom_sf(data = aoi_boundary_HARV, fill = "grey", color = "grey") +
#   geom_sf(data = point_HARV, aes(fill = Sub_Type)) +
#   geom_sf(data = lines_HARV, aes(color = TYPE), show.legend = "line",
#           size = 1) + 
#   scale_color_manual(values = road_colors, name = "Line Type") + 
#   scale_fill_manual(values = "black", name = "Tower Location") + 
#   ggtitle("NEON Harvard Forest Field Site") + 
#   coord_sf()
ggplot() + 
  geom_sf(data = boundary_Delft, fill = "grey", color = "grey") +
  geom_sf(data = point_Delft, aes(fill = leisure)) +
  geom_sf(data = lines_Delft_selection, aes(color = highway), 
          show.legend = "line", size = 1) + 
  scale_color_manual(values = road_colors, name = "Line Type") + 
  scale_fill_manual(values = rep("blue", 15), name = "Tower Location") + 
  ggtitle("Mobility network of Delft") + 
  coord_sf()
```

```{r}
# ggplot() +
#   geom_sf(data = aoi_boundary_HARV, fill = "grey", color = "grey") +
#   geom_sf(data = point_HARV, aes(fill = Sub_Type), shape = 15) +
#   geom_sf(data = lines_HARV, aes(color = TYPE),
#           show.legend = "line", size = 1) +
#   scale_color_manual(values = road_colors, name = "Line Type") +
#   scale_fill_manual(values = "black", name = "Tower Location") +
#   ggtitle("NEON Harvard Forest Field Site") + 
#   coord_sf()
ggplot() +
  geom_sf(data = boundary_Delft, fill = "grey", color = "grey") +
  geom_sf(data = point_Delft, aes(fill = leisure), shape = 15) +
  geom_sf(data = lines_Delft_selection, aes(color = highway),
          show.legend = "line", size = 1) +
  scale_color_manual(values = road_colors, name = "Line Type") +
  scale_fill_manual(values = rep("blue", 15), name = "Tower Location") +
  ggtitle("Mobility network of Delft") + 
  coord_sf()
```

### Challenge

```{r}
# plot_locations <- st_read(here("data","NEON-DS-Site-Layout-Files/HARV/PlotLocations_HARV.shp"))
leisure_locations_selection <- st_read(here("data", "delft-leisure.shp")) %>% 
  filter(leisure %in% c("playground", "picnic_table"))
```

```{r}
levels(factor(leisure_locations_selection$leisure))
```

```{r}
blue_orange <- c("cornflowerblue", "darkorange")
```

```{r}
ggplot() + 
  geom_sf(data = lines_Delft_selection, aes(color = highway)) + 
  geom_sf(data = leisure_locations_selection, aes(fill = leisure), 
          shape = 21, show.legend = 'point') + 
  scale_color_manual(name = "Line Type", values = road_colors,
     guide = guide_legend(override.aes = list(linetype = "solid", shape = NA))) + 
  scale_fill_manual(name = "Soil Type", values = blue_orange,
     guide = guide_legend(override.aes = list(linetype = "blank", shape = 21, colour = NA))) + 
  ggtitle("Traffic and leisure") + 
  coord_sf()
```

```{r}
ggplot() + 
  geom_sf(data = lines_Delft_selection, aes(color = highway), size = 1) + 
  geom_sf(data = leisure_locations_selection, aes(fill = leisure, shape = leisure), size = 3) + 
  scale_shape_manual(name = "Leisure Type", values = c(21, 22)) +
  scale_color_manual(name = "Line Type", values = road_colors) + 
  scale_fill_manual(name = "Leisure Type", values = rainbow(15),
     guide = guide_legend(override.aes = list(linetype = "blank", shape = c(21, 22),
     color = "black"))) + 
  ggtitle("Road network and leisure") + 
  coord_sf()
```

# Handling Spatial Projections and CRS (40 + 20 minutes)

## Working with spatial data from different sources

```{r}
# state_boundary_US <- st_read(here("data","NEON-DS-Site-Layout-Files/US-Boundary-Layers/US-State-Boundaries-Census-2014.shp"))
municipal_boundary_NL <- st_read(here("data","nl-gemeenten.shp"))
```

```{r}
ggplot() +
  geom_sf(data = municipal_boundary_NL) +
  ggtitle("Map of Contiguous NL Municipal Boundaries") +
  coord_sf()
```

```{r}
# country_boundary_US <- st_read(here("data", "NEON-DS-Site-Layout-Files/US-Boundary-Layers/US-Boundary-Dissolved-States.shp"))
country_boundary_NL <- st_read(here("data", "nl-boundary.shp"))
```

```{r}
ggplot() +
  geom_sf(data = country_boundary_NL, color = "gray18", size = 2) +
  geom_sf(data = municipal_boundary_NL, color = "gray40") +
  ggtitle("Map of Contiguous NL Municipal Boundaries") +
  coord_sf()
```

```{r}
st_crs(point_Delft)
```

```{r}
st_crs(municipal_boundary_NL)
```

```{r}
st_crs(country_boundary_NL)
```

```{r}
st_bbox(point_Delft)
```

```{r}
st_bbox(municipal_boundary_NL)
```

```{r}
# ggplot() +
#   geom_sf(data = country_boundary_US, size = 2, color = "gray18") +
#   geom_sf(data = state_boundary_US, color = "gray40") +
#   geom_sf(data = point_HARV, shape = 19, color = "purple") +
#   ggtitle("Map of Contiguous US State Boundaries") +
#   coord_sf()
ggplot() +
  geom_sf(data = country_boundary_NL, size = 2, color = "gray18") +
  geom_sf(data = municipal_boundary_NL, color = "gray40") +
  geom_sf(data = boundary_Delft, color = "purple", fill = "purple") +
  ggtitle("Map of Contiguous NL Municipal Boundaries") +
  coord_sf()
```

```{r}
# NE.States.Boundary.US <- st_read(here("data", "NEON-DS-Site-Layout-Files/US-Boundary-Layers/Boundary-US-State-NEast.shp"))
boundary_ZH <- municipal_boundary_NL %>% 
  filter(ligtInPr_1 == "Zuid-Holland")
```

```{r}
ggplot() +
    geom_sf(data = boundary_ZH, aes(color ="color"), show.legend = "line") +
    scale_color_manual(name = "", labels = "Municipal Boundaries", values = c("color" = "gray18")) +
    geom_sf(data = boundary_Delft, aes(shape = "shape"), color = "purple", fill = "purple") +
    scale_shape_manual(name = "", labels = "Municipality of Delft", values = c("shape" = 19)) +
    ggtitle("Delft location") +
    theme(legend.background = element_rect(color = NA)) +
    coord_sf()
```

## Export a shapefile
```{r}
st_write(leisure_locations_selection,
         here("data_output","leisure_locations_selection.shp"), driver = "ESRI Shapefile")
```
