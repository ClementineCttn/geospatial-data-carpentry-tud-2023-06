---
title: "Geospatial Carpentry | Session 4"
author: "Clémentine Cottineau"
date: "7/18/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

Let's import important libraries
```{r lib}
library(dplyr)
library(sf)
library(leaflet)
library(ggplot2)
library(tibble)
library(rgdal)
library(proj4)
library(remotes)
remotes::install_github('ropensci/osmdata')
library(osmdata)
library(osmextract)
# proj_db <- system.file("proj/proj.db", package = "sf")
```

## Import vector data from Open Street Map

```{r osm}
# from : https://cran.r-project.org/web/packages/osmdata/vignettes/osmdata.html


bb <- getbb('rotterdam, NL', format_out = 'sf_polygon')
x <- opq(bbox = bb) %>% 
   add_osm_feature(key = 'building') %>%
    osmdata_sf ()

str(x$osm_polygons)

```

Map building age focusing on post-war buildings
```{r reproject-and-map-age}
buildings <- x$osm_polygons %>% st_transform(.,crs=28992)

buildings$build_date <- ifelse(buildings$start_date <1945, 1945,buildings$start_date)
 ggplot(data = buildings) +
   geom_sf(aes(fill = as.numeric(build_date), colour=as.numeric(build_date)))  +
   scale_fill_viridis_c(option = "viridis")+
   scale_colour_viridis_c(option = "viridis")
```

Let's focus on really old building and imagine we're in charge of conservation. We want to know how much of the city would be affected by a non-construction zone of 500m around pre-1800 buildings.

# Selecting old buildings
```{r old-buildings}
old <- 1800 # year prior to which you consider a building old
 distance <- 500 # in meters
 
old_buildings <- filter(buildings, start_date <= old)
 ggplot(data = old_buildings) + geom_sf()
 
```

# Creating a buffer around a polygon
```{r buffers}

 buffer_old_buildings <- st_buffer(old_buildings, dist = distance)
 ggplot(data = buffer_old_buildings) + geom_sf()
  
```

# Fusing overlapping buffers into a single polygon
```{r union}

 single_old_buffer <- st_union(buffer_old_buildings) %>% 
   st_cast(to = "POLYGON") %>% st_as_sf()  %>% 
   add_column("ID"=as.factor(1:nrow(.)))  %>% st_transform(.,crs=4326) 
  
```

# Representing old buildings by their centroid
```{r centroids}
sf::sf_use_s2(FALSE)
centroids_old <- st_centroid(old_buildings) %>% st_transform(.,crs=4326)  
ggplot() + 
    geom_sf(data = single_old_buffer, aes(fill=ID)) +
    geom_sf(data = centroids_old)
```

# Counting the number of centroid per buffer with st_intersection (/!\ ≠st_intersect!)
```{r intersection}
 centroids_buffers <- st_intersection(centroids_old,single_old_buffer) %>% 
   add_column(n=1)
 centroid_by_buffer <- centroids_buffers %>% 
   group_by(ID) %>%
   summarise(
   n = sum(n)
   )
 single_buffer <- single_old_buffer %>% add_column(n_buildings = centroid_by_buffer$n)

 ggplot() + 
   geom_sf(data = single_buffer, aes(fill=n_buildings)) +
   scale_fill_viridis_c(alpha = 0.8,
                        begin = 0.6,
                        end = 1,
                        direction = -1,
                        option = "B")
 
```

# Final visualisation 
```{r visu-1800}
ggplot() + 
   geom_sf(data = buildings) +
   geom_sf(data = single_buffer, aes(fill=n_buildings), colour = NA) +
   scale_fill_viridis_c(alpha = 0.6,
                        begin = 0.6,
                        end = 1,
                        direction = -1,
                        option = "B") 

 old <- 1939 # year prior to which you consider a building old
 distance <- 100 # in meters
```
 
 
# Now let's look at the same analysis but for pre-war buildings and 100m buffers
```{r prewar-replication}
 old <- 1939 
 distance <- 100
 #select
 old_buildings <- filter(buildings, start_date <= old)
 #buffer
  buffer_old_buildings <- st_buffer(old_buildings, dist = distance)
  #union
 single_old_buffer <- st_union(buffer_old_buildings) %>% 
   st_cast(to = "POLYGON") %>% st_as_sf()  %>% 
   add_column("ID"=1:nrow(.))  %>% st_transform(.,crs=4326) 
 #centroids
 centroids_old <- st_centroid(old_buildings) %>% st_transform(.,crs=4326)  
  #intersection
  centroids_buffers <- st_intersection(centroids_old,single_old_buffer) %>% 
   add_column(n=1)
 centroid_by_buffer <- centroids_buffers %>% 
   group_by(ID) %>%
   summarise(
   n = sum(n)
   )
 single_buffer <- single_old_buffer %>% add_column(n_buildings = centroid_by_buffer$n)
  ggplot() + 
   geom_sf(data = buildings) +
   geom_sf(data = single_buffer, aes(fill=n_buildings), colour = NA) +
   scale_fill_viridis_c(alpha = 0.6,
                        begin = 0.6,
                        end = 1,
                        direction = -1,
                        option = "B") 
   
```

Problem: there are many pre-war buildings and the buffers are large so the number of old buildings is not very meaningful. Let's compute the density of old buildings per buffer zone.


# Visualisation
```{r area}
single_buffer$area <- st_area(single_buffer, ) %>% units::set_units(., km^2)
 single_buffer$old_buildings_per_km2 <- as.numeric(single_buffer$n_buildings / single_buffer$area)

 ggplot() + 
   geom_sf(data = buildings) +
   geom_sf(data = single_buffer, aes(fill=old_buildings_per_km2), colour = NA) +
   scale_fill_viridis_c(alpha = 0.6,
                        begin = 0.6,
                        end = 1,
                        direction = -1,
                        option = "B") 
 
```


## EXERCISE!

# Get OSM limits of Rotterdam
```{r rdam-limits}
 rdam <- getbb(
  place_name = "Rotterdam",
  format_out = 'sf_polygon',
  silent = FALSE
) 
```

# Import and reproject CBS 500mx500m grid cells for the entire NL
```{r import-cbs}
# downloaded from: https://www.cbs.nl/-/media/cbs/dossiers/nederland-regionaal/vierkanten/500/2022-cbs_vk500_2019_vol.zip 
cells_NL <- st_read("2019-cbs_vk500_2015_v2/CBS_VK500_2015_v2.shp") %>%
  mutate_if(is.numeric, funs(ifelse(.==-99997, NA, .)))
cells_NL <- st_transform(cells_NL,crs=4326) 
```

# INTERSECT (≠ st_intersection) to keep only cells for rotterdam
```{r intersect}
intersect_cells_rdam <- st_intersects(cells_NL, rdam, sparse=F)
intersect_cells_rdam_sf <- cbind(intersect_cells_rdam,cells_NL)
cells_rdam <- intersect_cells_rdam_sf %>% 
  filter(X1 == T ) 

plot(cells_rdam)

```



